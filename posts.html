<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lost/Found Listings</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#2bee4b",
            "background-light": "#f6f8f6",
            "neutral-light": "#f8fcf9",
            "border-light": "#e7f3e9",
            "text-primary-light": "#0d1b10",
            "text-secondary-light": "#4c9a59"
          },
          fontFamily: { display: ["Inter", "sans-serif"] },
          borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem"}
        }
      }
    }
  </script>
  <style>
    .material-symbols-outlined { font-variation-settings: 'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24; }
    /* small visual helpers to match your look */
    .card-ring { box-shadow: 0 0 0 4px rgba(46, 189, 75, .06); border-radius: .75rem; }
  </style>
</head>
<body class="bg-background-light font-display text-text-primary-light">

  <!-- HEADER -->
  <header class="flex items-center justify-between border-b border-border-light px-8 py-4 sticky top-0 bg-background-light z-30">
    <div class="flex items-center gap-4">
      <div class="text-primary w-7 h-7">
        <svg viewBox="0 0 48 48" fill="currentColor"><path d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z"/></svg>
      </div>
      <h2 class="text-lg font-bold">Campus Lost &amp; Found</h2>
    </div>

    <nav class="flex items-center gap-6">
      <a id="homeLink" class="text-sm font-medium cursor-pointer">Home</a>
      <a id="myPostsLink" class="text-sm font-medium cursor-pointer">My Posts</a>
      <a id="messagesLink" class="text-sm font-medium cursor-pointer">Messages</a>
      <!-- Profile avatar -->
      <div id="profileAvatar" class="w-9 h-9 rounded-full bg-center bg-cover ml-4" title="Profile"></div>
    </nav>
  </header>

  <!-- MAIN -->
  <main class="py-8 px-6 max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <!-- Sidebar -->
      <aside class="lg:col-span-3">
        <div class="bg-neutral-light rounded-xl border border-border-light p-6 sticky top-28">
          <h3 class="text-lg font-bold mb-4">Filter by</h3>

          <!-- Type buttons -->
          <div class="mb-4">
            <div class="flex gap-2 bg-border-light rounded-full p-1">
              <label data-type="all" class="flex-1 text-center py-2 rounded-full cursor-pointer selected-type bg-green-50">Show All
                <input type="radio" name="typeFilter" value="all" class="hidden" checked>
              </label>
              <label data-type="LOST" class="flex-1 text-center py-2 rounded-full cursor-pointer">Lost
                <input type="radio" name="typeFilter" value="LOST" class="hidden">
              </label>
              <label data-type="FOUND" class="flex-1 text-center py-2 rounded-full cursor-pointer">Found
                <input type="radio" name="typeFilter" value="FOUND" class="hidden">
              </label>
            </div>
          </div>

          <div class="mb-4">
            <label class="text-sm font-medium block mb-2">Category</label>
            <select id="categorySelect" class="w-full rounded-lg border border-border-light h-12 px-3 text-sm bg-white">
              <option value="">All Categories</option>
            </select>
          </div>

          <div class="mb-4">
            <label class="text-sm font-medium block mb-2">Campus Zone</label>
            <select id="zoneSelect" class="w-full rounded-lg border border-border-light h-12 px-3 text-sm bg-white">
              <option value="">All Zones</option>
            </select>
          </div>

          <div class="mb-4">
            <label class="text-sm font-medium block mb-2">Date Posted</label>
            <input id="dateSelect" type="date" class="w-full rounded-lg border border-border-light h-12 px-3 text-sm bg-white"/>
          </div>

          <div class="text-center mt-2">
            <button id="resetFilters" class="text-sm text-text-secondary-light">Reset Filters</button>
          </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="lg:col-span-9">
        <div class="mb-6">
          <h1 class="text-4xl font-black mb-4">All Lost &amp; Found Items</h1>

          <div class="relative mb-6">
            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-text-secondary-light">search</span>
            <input id="searchInput" placeholder="Search for an item..." class="w-full h-12 rounded-lg border-2 border-primary/30 px-12 placeholder:text-text-secondary-light" />
          </div>
        </div>

        <!-- Cards grid -->
        <div id="cardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <!-- Pagination -->
        <div class="flex justify-center items-center gap-3 mt-8">
          <button id="prevPage" class="p-2 rounded bg-neutral-light border border-border-light"><span class="material-symbols-outlined">chevron_left</span></button>
          <div id="pageNumbers" class="flex items-center gap-2"></div>
          <button id="nextPage" class="p-2 rounded bg-neutral-light border border-border-light"><span class="material-symbols-outlined">chevron_right</span></button>
        </div>
      </section>
    </div>
  </main>

  <!-- EDIT MODAL -->
  <div id="editModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-40">
    <div class="bg-white rounded-lg w-[95%] md:w-[720px] p-6">
      <h3 class="text-lg font-bold mb-4">Edit Post</h3>
      <div class="space-y-3">
        <input id="edit_itemName" class="w-full rounded border p-2" placeholder="Item name"/>
        <textarea id="edit_description" class="w-full rounded border p-2" rows="4" placeholder="Description"></textarea>
        <div class="flex gap-3">
          <input id="edit_date" type="date" class="rounded border p-2"/>
          <input id="edit_location" class="rounded border p-2 flex-1" placeholder="Location"/>
        </div>
        <div class="flex gap-3">
          <select id="edit_category" class="rounded border p-2 flex-1"><option value="">Category</option></select>
          <select id="edit_zone" class="rounded border p-2 flex-1"><option value="">Zone</option></select>
          <select id="edit_type" class="rounded border p-2 w-32">
            <option value="LOST">LOST</option>
            <option value="FOUND">FOUND</option>
          </select>
        </div>
        <div class="flex items-center gap-3">
          <input id="edit_image_input" type="file" accept="image/*" />
          <img id="edit_image_preview" class="w-20 h-20 object-cover rounded" src="" alt="preview"/>
        </div>
      </div>
      <div class="mt-4 flex justify-end gap-3">
        <button id="cancelEdit" class="px-4 py-2 rounded border">Cancel</button>
        <button id="saveEdit" class="px-4 py-2 rounded bg-primary">Save</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // --- Config & state ---
    const currentUser = JSON.parse(localStorage.getItem('currentUser')) || { email: '' };
    let posts = JSON.parse(localStorage.getItem('posts')) || [];
    let currentPage = 1;
    const pageSize = 9;

    // DOM refs
    const cardsGrid = document.getElementById('cardsGrid');
    const searchInput = document.getElementById('searchInput');
    const categorySelect = document.getElementById('categorySelect');
    const zoneSelect = document.getElementById('zoneSelect');
    const dateSelect = document.getElementById('dateSelect');
    const resetFilters = document.getElementById('resetFilters');
    const pageNumbers = document.getElementById('pageNumbers');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const profileAvatar = document.getElementById('profileAvatar');

    const typeButtons = document.querySelectorAll('[data-type]');
    const homeLink = document.getElementById('homeLink');
    const messagesLink = document.getElementById('messagesLink');
    const myPostsLink = document.getElementById('myPostsLink');

    // edit modal refs
    const editModal = document.getElementById('editModal');
    const edit_itemName = document.getElementById('edit_itemName');
    const edit_description = document.getElementById('edit_description');
    const edit_date = document.getElementById('edit_date');
    const edit_location = document.getElementById('edit_location');
    const edit_category = document.getElementById('edit_category');
    const edit_zone = document.getElementById('edit_zone');
    const edit_type = document.getElementById('edit_type');
    const edit_image_input = document.getElementById('edit_image_input');
    const edit_image_preview = document.getElementById('edit_image_preview');
    const cancelEdit = document.getElementById('cancelEdit');
    const saveEdit = document.getElementById('saveEdit');

    // show avatar if available
    if (currentUser && currentUser.avatar) profileAvatar.style.backgroundImage = `url('${currentUser.avatar}')`;
    else profileAvatar.style.backgroundColor = '#f3d9c7';

    // --- Utilities ---
    function savePosts() { localStorage.setItem('posts', JSON.stringify(posts)); }
    function formatISO(d) { if (!d) return ''; const dt = new Date(d); return isNaN(dt) ? d : dt.toISOString().slice(0,10); }
    function toDataUrl(file, cb){ const r=new FileReader(); r.onload=e=>cb(e.target.result); r.readAsDataURL(file); }

    // If no posts exist create demo data so UI isn't empty
    function ensureDemoData(){
      if (!posts || posts.length === 0){
        posts = [
          { itemName:'LapBag', description:'hp lapbag blac color', date: formatISO(new Date()), location:'Library', category:'Bags', zone:'Library', image:'', user: currentUser.email || 'demo1@example.com', type:'LOST', time:new Date().toLocaleString() },
          { itemName:'Water Bottle', description:'bottle is safe, contact me', date: formatISO(new Date(Date.now()-86400000)), location:'Canteen', category:'Bottles', zone:'Canteen', image:'', user: 'someone@example.com', type:'FOUND', time:new Date(Date.now()-86400000).toLocaleString() }
        ];
        savePosts();
      }
    }

    // populate category/zone selects from existing posts
    function populateCategoryZone(){
      const cats = new Set(), zones = new Set();
      posts.forEach(p=>{ if(p.category) cats.add(p.category); if(p.zone) zones.add(p.zone); });
      categorySelect.innerHTML = '<option value="">All Categories</option>';
      edit_category.innerHTML = '<option value="">Category</option>';
      cats.forEach(c => {
        categorySelect.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`);
        edit_category.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`);
      });
      zoneSelect.innerHTML = '<option value="">All Zones</option>';
      edit_zone.innerHTML = '<option value="">Zone</option>';
      zones.forEach(z => {
        zoneSelect.insertAdjacentHTML('beforeend', `<option value="${z}">${z}</option>`);
        edit_zone.insertAdjacentHTML('beforeend', `<option value="${z}">${z}</option>`);
      });
    }

    // get filter state
    function getFilterState(){
      const typeEl = Array.from(typeButtons).find(b => b.querySelector('input') && b.querySelector('input').checked);
      const type = typeEl ? typeEl.dataset.type : 'all';
      return {
        type,
        q: (searchInput.value||'').trim().toLowerCase(),
        category: categorySelect.value || '',
        zone: zoneSelect.value || '',
        date: dateSelect.value || '',
        myOnly: myPostsLink.classList.contains('active')
      };
    }

    // filter posts
    function filterPosts(){
      const { type, q, category, zone, date, myOnly } = getFilterState();

      // normalize dates if missing
      posts = posts.map(p => {
        if (!p.date && p.time) {
          try { const d = new Date(p.time); if (!isNaN(d)) p.date = d.toISOString().slice(0,10); } catch(e){}
        }
        return p;
      });

      return posts.filter(p=>{
        if (type && type !== 'all' && (p.type || 'LOST') !== type) return false;
        if (category && p.category !== category) return false;
        if (zone && p.zone !== zone) return false;
        if (date && p.date !== date) return false;
        if (myOnly && p.user !== currentUser.email) return false;
        if (q){
          const hay = `${p.itemName||''} ${p.description||''} ${p.location||''} ${p.category||''} ${p.zone||''}`.toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });
    }

    // render posts with pagination
    function render(){
      populateCategoryZone();
      const filtered = filterPosts();
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage-1)*pageSize;
      const pageItems = filtered.slice(start, start+pageSize);

      cardsGrid.innerHTML = '';
      pageItems.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'flex flex-col gap-4 rounded-xl border border-border-light bg-neutral-light p-4 card-ring';

        // image area
        const imgDiv = document.createElement('div');
        imgDiv.className = 'bg-center bg-no-repeat aspect-video bg-cover rounded-lg';
        if (p.image) imgDiv.style.backgroundImage = `url('${p.image}')`;
        else imgDiv.style.backgroundImage = 'linear-gradient(90deg,#f0f0f0,#e9f4ea)';
        card.appendChild(imgDiv);

        // content
        const content = document.createElement('div');
        content.className = 'flex flex-col gap-3';

        const topRow = document.createElement('div'); topRow.className='flex justify-between items-start';
        const title = document.createElement('h3'); title.className='font-bold text-base'; title.textContent = p.itemName || 'Untitled';
        const badge = document.createElement('span'); badge.className='text-xs font-medium px-2 py-1 rounded-full';
        badge.textContent = (p.type||'LOST').toUpperCase();
        if ((p.type||'LOST').toUpperCase()==='FOUND'){ badge.classList.add('bg-green-100','text-green-700'); } else { badge.classList.add('bg-amber-100','text-amber-600'); }
        topRow.appendChild(title); topRow.appendChild(badge); content.appendChild(topRow);

        const meta = document.createElement('div'); meta.className='flex items-center gap-4 text-xs text-text-secondary-light';
        meta.innerHTML = `<div class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm">calendar_today</span><span>${p.date||''}</span></div>
                          <div class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm">location_on</span><span>${p.location||''}</span></div>
                          <div class="flex items-center gap-1.5"><span class="material-symbols-outlined text-sm">category</span><span>${p.category||''}</span></div>`;
        content.appendChild(meta);

        const desc = document.createElement('p'); desc.className='text-sm text-text-secondary-light';
        desc.textContent = p.description ? (p.description.length>140 ? p.description.slice(0,140)+'...' : p.description) : '';
        content.appendChild(desc);

        const posted = document.createElement('div'); posted.className='text-xs text-text-secondary-light';
        posted.textContent = `Posted by: ${p.user || 'unknown'} • ${p.time || ''}`;
        content.appendChild(posted);

        const actions = document.createElement('div'); actions.className='flex gap-2 mt-2';
        const viewBtn = document.createElement('button'); viewBtn.className='px-3 py-1 rounded bg-white border border-border-light'; viewBtn.textContent='View';
       viewBtn.addEventListener('click', () => {
  if (p.image && p.image !== "") {
    openImageModal(p.image);
  } else {
    alert("No image available for this post.");
  }
});
// REPORT BUTTON (any user can report)
const reportBtn = document.createElement("button");
reportBtn.className = "px-3 py-1 rounded bg-red-500 text-white";
reportBtn.textContent = "Report";

reportBtn.addEventListener("click", () => {
    let reason = prompt("Why are you reporting this item?");
    if (!reason) return;

    let flagged = JSON.parse(localStorage.getItem("flaggedPosts")) || [];

    flagged.push({
        ...p,
        reportReason: reason,
        reportedBy: currentUser.email || "unknown",
        reportedAt: new Date().toLocaleString()
    });

    localStorage.setItem("flaggedPosts", JSON.stringify(flagged));
    alert("Item reported successfully!");
});

actions.appendChild(reportBtn);



        // edit + delete only for poster
        if (currentUser.email && p.user === currentUser.email){
          const editBtn = document.createElement('button'); editBtn.className='px-3 py-1 rounded bg-blue-600 text-white'; editBtn.textContent='Edit';
          editBtn.addEventListener('click', ()=> openEditModal(p));
          const delBtn = document.createElement('button'); delBtn.className='px-3 py-1 rounded bg-red-600 text-white'; delBtn.textContent='Delete';
          delBtn.addEventListener('click', ()=> {
            if (confirm('Delete this post?')){
              posts = posts.filter(pp => !(pp.time===p.time && pp.user===p.user && pp.itemName===p.itemName));
              savePosts(); render();
            }
          });
          actions.appendChild(editBtn); actions.appendChild(delBtn);
        }

        content.appendChild(actions);
        card.appendChild(content);
        cardsGrid.appendChild(card);
      });

      // pagination UI
      pageNumbers.innerHTML = '';
      const totalPagesNow = Math.max(1, Math.ceil(filtered.length / pageSize));
      for (let i=1;i<=Math.min(totalPagesNow,7);i++){
        const btn = document.createElement('button');
        btn.className = `px-3 py-1 rounded ${i===currentPage ? 'bg-primary text-white' : 'bg-neutral-light'}`;
        btn.textContent = i;
        btn.addEventListener('click', ()=> { currentPage = i; render(); });
        pageNumbers.appendChild(btn);
      }
      prevPage.disabled = currentPage<=1;
      nextPage.disabled = currentPage>=totalPagesNow;
    }

    // --- events ---
    searchInput.addEventListener('input', ()=>{ currentPage=1; render(); });
    categorySelect.addEventListener('change', ()=>{ currentPage=1; render(); });
    zoneSelect.addEventListener('change', ()=>{ currentPage=1; render(); });
    dateSelect.addEventListener('change', ()=>{ currentPage=1; render(); });
    resetFilters.addEventListener('click', ()=>{
      searchInput.value=''; categorySelect.value=''; zoneSelect.value=''; dateSelect.value='';
      document.querySelector('[data-type="all"]').querySelector('input').checked = true;
      typeButtons.forEach(b => b.classList.remove('bg-green-50','rounded-full'));
      document.querySelector('[data-type="all"]').classList.add('bg-green-50','rounded-full');
      myPostsLink.classList.remove('active'); currentPage=1; render();
    });

    // type buttons click
    typeButtons.forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const input = btn.querySelector('input');
        if (input) input.checked = true;
        typeButtons.forEach(b => b.classList.remove('bg-green-50','rounded-full'));
        btn.classList.add('bg-green-50','rounded-full');
        currentPage = 1; render();
      });
    });
    // set initial visual
    document.querySelector('[data-type="all"]').classList.add('bg-green-50','rounded-full');

    // my posts toggle
    myPostsLink.addEventListener('click', ()=> { myPostsLink.classList.toggle('active'); currentPage=1; render(); });
    // navigation
    homeLink.addEventListener('click', ()=> window.location.href = 'dashboard.html');
    messagesLink.addEventListener('click', ()=> window.location.href = 'chat.html');

    // prev/next page
    prevPage.addEventListener('click', ()=> { if (currentPage>1) { currentPage--; render(); } });
    nextPage.addEventListener('click', ()=> {
      const total = filterPosts().length; const totalPagesNow = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage < totalPagesNow) { currentPage++; render(); }
    });

    // --- EDIT modal logic ---
    let editingIndex = null;
    function openEditModal(post){
      const idx = posts.findIndex(pp=>pp.time===post.time && pp.user===post.user && pp.itemName===post.itemName);
      if (idx<0) { alert('Post not found'); return; }
      editingIndex = idx;
      const p = posts[idx];
      edit_itemName.value = p.itemName || '';
      edit_description.value = p.description || '';
      edit_date.value = p.date || (p.time? p.time.slice(0,10): '');
      edit_location.value = p.location || '';
      edit_category.value = p.category || '';
      edit_zone.value = p.zone || '';
      edit_type.value = p.type || 'LOST';
      edit_image_preview.src = p.image || '';
      editModal.classList.remove('hidden');
    }
    cancelEdit.addEventListener('click', ()=> { editingIndex = null; editModal.classList.add('hidden'); });
    edit_image_input.addEventListener('change', (e)=> {
      const f = e.target.files[0]; if (!f) return;
      toDataUrl(f, dataUrl => { edit_image_preview.src = dataUrl; });
    });
    saveEdit.addEventListener('click', ()=> {
      if (editingIndex === null) return;
      posts[editingIndex].itemName = edit_itemName.value.trim();
      posts[editingIndex].description = edit_description.value.trim();
      posts[editingIndex].date = edit_date.value || posts[editingIndex].date;
      posts[editingIndex].location = edit_location.value.trim();
      posts[editingIndex].category = edit_category.value;
      posts[editingIndex].zone = edit_zone.value;
      posts[editingIndex].type = edit_type.value;
      if (edit_image_preview.src && edit_image_preview.src.startsWith('data:')) posts[editingIndex].image = edit_image_preview.src;
      savePosts();
      editModal.classList.add('hidden'); editingIndex = null; render();
    });

    // --- init ---
    function init(){
      ensureDemoData();
      populateCategoryZone();
      render();
    }

    // expose refresh for other pages (report.html can call window.refreshPostsPage())
    window.refreshPostsPage = function(){ posts = JSON.parse(localStorage.getItem('posts')) || []; populateCategoryZone(); render(); };

    init();
  })();
  // --- ONE-TIME CLEANUP FOR OLD POSTS (removes only posts with unknown user) ---
(function cleanOldUnknownPosts() {
    let posts = JSON.parse(localStorage.getItem("posts")) || [];

    // Filter: remove posts where user is missing or user == "unknown"
    const cleaned = posts.filter(p => p.user && p.user !== "unknown");

    // Only save if something was removed
    if (cleaned.length !== posts.length) {
        localStorage.setItem("posts", JSON.stringify(cleaned));
        console.log("Old posts with 'unknown' deleted successfully.");
    }
})();
// Open image modal
function openImageModal(src) {
  document.getElementById("modalImg").src = src;
  document.getElementById("imageModal").classList.remove("hidden");
}

// Close modal
function closeImageModal() {
  document.getElementById("imageModal").classList.add("hidden");
}


  </script>
  <!-- IMAGE VIEW MODAL -->
<div id="imageModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <img id="modalImg" class="max-w-[90%] max-h-[90%] rounded-xl shadow-xl" />
  <button onclick="closeImageModal()" class="absolute top-6 right-6 text-white text-3xl">✕</button>
</div>

</body>
</html>
